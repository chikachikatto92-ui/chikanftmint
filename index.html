<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>CHIKA NFT Minting • Shibarium</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
:root{
  --bg:#0b0f14;--muted:#d1cfcf;--text:#fff8f0;--accent:#f7a72c;--accent-2:#ff6b6b;--highlight:#ffcd73;--danger:#ff4f4f;
  --card-bg:rgba(255,255,255,0.04);--card-border:rgba(255,255,255,0.1);--glow:rgba(247,167,44,0.4);
}
*{box-sizing:border-box;}
html,body{height:100%;margin:0;font-family:'Inter','Segoe UI',sans-serif;
background:radial-gradient(ellipse at top left,rgba(247,167,44,0.15),transparent 60%),
radial-gradient(ellipse at bottom right,rgba(255,107,107,0.12),transparent 70%),
linear-gradient(135deg,#0b0f14,#1b1f2c);
color:var(--text);display:flex;align-items:center;justify-content:center;padding:24px;}
.card{width:100%;max-width:720px;background:var(--card-bg);backdrop-filter:blur(10px);
border:1px solid var(--card-border);border-radius:20px;padding:28px;
box-shadow:0 20px 50px rgba(0,0,0,0.4);transition:transform .3s,box-shadow .3s;}
.card:hover{transform:translateY(-4px);box-shadow:0 25px 60px rgba(0,0,0,0.5);}
.header{display:flex;justify-content:space-between;gap:12px;align-items:center;
border-bottom:1px solid var(--card-border);padding-bottom:16px;margin-bottom:20px;}
.title{font-weight:800;font-size:24px;letter-spacing:.3px;color:var(--accent);}
.muted{color:var(--muted);font-size:14px;}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
button,input[type=number]{height:46px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
background:#1a1f2a;color:var(--text);font-weight:600;transition:all .3s ease;}
button:hover{transform:translateY(-2px);box-shadow:0 0 8px var(--accent);}
button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));
border:none;box-shadow:0 4px 15px var(--glow);color:#fff;}
button:disabled{opacity:.5;cursor:not-allowed;box-shadow:none;}
input[type=number]{padding:0 14px;width:100px;background:#121828;}
.stat{flex:1;min-width:140px;background:rgba(255,255,255,0.02);
border:1px solid rgba(255,255,255,.1);padding:14px 16px;border-radius:14px;}
.stat .label{font-size:13px;color:var(--muted);}
.stat .value{font-size:20px;font-weight:700;margin-top:6px;color:var(--highlight);}
.progress{position:relative;height:14px;background:rgba(255,255,255,.06);
border-radius:999px;overflow:hidden;border:1px solid var(--card-border);margin:12px 0;}
.progress>span{position:absolute;inset:0 auto 0 0;width:0;
background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .6s ease;border-radius:999px;}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;}
@media(max-width:720px){.grid{grid-template-columns:1fr;}}
.note{font-size:13px;color:var(--muted);margin-top:8px;}
.error{color:var(--danger);font-size:14px;margin-top:10px;display:none;}
.success{color:#7dffb6;font-size:14px;margin-top:10px;display:none;}
.divider{height:1px;background:var(--card-border);margin:18px 0;}
.footer{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;font-size:14px;}
.badge{font-size:13px;color:#0b1220;background:rgba(247,167,44,.9);
padding:6px 12px;border-radius:999px;font-weight:700;box-shadow:0 2px 10px var(--glow);}
#contractAddress{font-family:monospace;user-select:all;}
.side-images{position:fixed;top:50%;transform:translateY(-50%);
display:flex;flex-direction:column;gap:16px;z-index:1;}
.side-images.left{left:16px;}
.side-images.right{right:16px;}
.side-images img{width:360px;height:360px;object-fit:cover;
border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.4);transition:transform 0.3s;}
.side-images img:hover{transform:scale(1.1);}
</style>
</head>
<body>

<div class="side-images left" id="leftImages"></div>
<div class="side-images right" id="rightImages"></div>

<div class="card">
  <div class="header">
    <div>
      <div class="title">CHIKA NFT Minting</div>
      <div class="muted" id="network">Not connected</div>
    </div>
    <div class="row">
      <button id="connectBtn">Connect Wallet</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="row" style="margin-bottom:10px">
        <div class="stat"><div class="label">Minted</div><div class="value" id="minted">0</div></div>
        <div class="stat"><div class="label">Remaining</div><div class="value" id="remaining">—</div></div>
        <div class="stat" id="mintPriceContainer">
          <div class="label">Price (per NFT)</div><div class="value" id="price">—</div>
        </div>
      </div>
      <div class="progress"><span id="bar"></span></div>
      <div class="note">Live counter updates every ~10 seconds. Values in BONE.</div>
      <div id="status" class="note"></div>
    </div>

    <div>
      <div class="row" style="margin-bottom:8px">
        <input type="number" id="qty" min="1" max="10" value="1"/>
        <button id="maxBtn">Max</button>
      </div>
      <button class="primary" id="mintBtn">Mint</button>
      <div id="txMsg" class="note"></div>
      <div id="err" class="error"></div>
      <div id="ok" class="success"></div>
    </div>
  </div>

  <div class="divider"></div>
  <div class="footer">
    <div class="badge" id="saleStateContainer">Sale: <span id="saleState">unknown</span></div>
    <div class="muted">Contract: <span id="contractAddress"></span></div>
  </div>
</div>

<script>
const CONTRACT_ADDRESS = "0xF8f328390E3bb01773c22cE874848612eF04F579";
const BONE_ADDRESS = "0x0000000000000000000000000000000000001010";
const FALLBACK_MAX_SUPPLY = 10000;
const SHIBARIUM = {
  chainId:"0x6d",
  chainName:"Shibarium Mainnet",
  nativeCurrency:{name:"BONE",symbol:"BONE",decimals:18},
  rpcUrls:["https://www.shibrpc.com"],
  blockExplorerUrls:["https://www.shibariumscan.io"]
};

let provider, signer, user, contract;
const $ = id => document.getElementById(id);
const ui = {
  network:$("network"), minted:$("minted"), remaining:$("remaining"),
  bar:$("bar"), price:$("price"), sale:$("saleState"),
  addr:$("contractAddress"), qty:$("qty"),
  mintBtn:$("mintBtn"), connectBtn:$("connectBtn"), maxBtn:$("maxBtn"),
  txMsg:$("txMsg"), err:$("err"), ok:$("ok"), status:$("status")
};
ui.addr.textContent = CONTRACT_ADDRESS;

// ----- ERROR HANDLERS -----
function showErr(e){ ui.err.style.display="block"; ui.err.textContent=e.message||e; console.error(e); setTimeout(()=>{ui.err.style.display="none"},5000); }
function showOk(m){ ui.ok.style.display="block"; ui.ok.textContent=m; setTimeout(()=>ui.ok.style.display="none",5000); }
function hideErr(){ ui.err.style.display="none"; ui.err.textContent=""; }

// ----- CONNECT WALLET -----
async function connectWallet(){
  try{
    if(!window.ethereum) throw new Error("MetaMask not installed");
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts",[]);
    signer = provider.getSigner();
    user = await signer.getAddress();

    const network = await provider.getNetwork();
    if(network.chainId !== 109){
      await window.ethereum.request({method:"wallet_addEthereumChain",params:[SHIBARIUM]});
    }

    const abiRes = await fetch(`https://www.shibariumscan.io/api?module=contract&action=getabi&address=${CONTRACT_ADDRESS}`);
    const abiData = await abiRes.json();
    if(abiData.status !== "1") throw new Error("Failed to fetch ABI");
    const abi = JSON.parse(abiData.result);

    contract = new ethers.Contract(CONTRACT_ADDRESS, abi, signer);

    ui.network.textContent = "Connected to Shibarium ✅";
    ui.connectBtn.textContent = user.slice(0,6)+"…"+user.slice(-4);
    ui.mintBtn.disabled = false;

    await updateStats();
    setInterval(updateStats,10000);
  }catch(e){ showErr(e); }
}

// ----- UPDATE STATS -----
async function updateStats(){
  if(!contract) return;
  try{
    const total = await contract.totalSupply();
    let max = FALLBACK_MAX_SUPPLY;
    try{ max = await contract.MAX_SUPPLY(); }catch{}
    const price = await contract.MINT_PRICE();
    const sale = await contract.saleActive();
    ui.minted.textContent = total.toString();
    ui.remaining.textContent = (max-total).toString();
    ui.bar.style.width = ((total*100)/max)+"%";
    ui.price.textContent = ethers.utils.formatEther(price)+" BONE";
    ui.sale.textContent = sale?"Active":"Closed";
  }catch(e){ console.warn(e); }
}

// ----- UPDATE USER LIMITS -----
async function updateUserLimits(){
  if(!contract) return 1;
  try{
    const maxPerTx = await contract.MAX_PER_TX().catch(()=>30);
    const maxPerWallet = await contract.MAX_PER_WALLET().catch(()=>30);
    const mintedByUser = await contract.mintedBy(user).catch(()=>0);
    const totalSupply = await contract.totalSupply().catch(()=>0);
    const maxSupply = await contract.MAX_SUPPLY().catch(()=>FALLBACK_MAX_SUPPLY);

    const remainingWallet = maxPerWallet - mintedByUser;
    const remainingTotal = maxSupply - totalSupply;

    const allowedMax = Math.min(maxPerTx, remainingWallet, remainingTotal);
    ui.qty.max = allowedMax > 0 ? allowedMax : 1;
    return allowedMax;
  }catch(e){ console.warn(e); return 1; }
}

// ----- MAX BUTTON -----
ui.maxBtn.onclick = async ()=>{
  const maxQty = await updateUserLimits();
  ui.qty.value = maxQty;
};

// ----- AUTO CLAMP INPUT -----
ui.qty.addEventListener("input", async () => {
    const maxQty = await updateUserLimits();
    let val = parseInt(ui.qty.value);
    if(isNaN(val) || val < 1) val = 1;
    if(val > maxQty) val = maxQty;
    ui.qty.value = val;
});

// ----- MINT NFT -----
async function mintNFT(){
  hideErr();
  ui.ok.style.display="none";

  try{
    const maxQty = await updateUserLimits();
    let qty = parseInt(ui.qty.value);
    if(qty <= 0) throw new Error("Invalid quantity");
    if(qty > maxQty) qty = maxQty;
    ui.qty.value = qty;

    const price = await contract.MINT_PRICE();
    const total = price.mul(qty);

    const BONE = new ethers.Contract(
      BONE_ADDRESS,
      ["function allowance(address owner,address spender) view returns(uint256)",
       "function approve(address spender,uint256 amount) returns(bool)"],
      signer
    );

    let allowance = await BONE.allowance(user, CONTRACT_ADDRESS);
    if(allowance.lt(total)){
      ui.txMsg.textContent = "Requesting BONE approval…";
      const approveTx = await BONE.approve(CONTRACT_ADDRESS, total);
      await approveTx.wait();
      ui.txMsg.textContent = "✅ Approval successful!";
    }

    ui.txMsg.textContent = `Minting ${qty} NFT(s)…`;
    const tx = await contract.mint(qty);
    await tx.wait();

    ui.txMsg.textContent = "";
    showOk(`✅ Mint successful! Quantity: ${qty}`);
    await updateStats();
  }catch(e){ ui.txMsg.textContent=""; showErr(e); }
}

// ----- BUTTON EVENTS -----
ui.connectBtn.onclick = connectWallet;
ui.mintBtn.onclick = mintNFT;

// ----- FLOATING IMAGES -----
const leftImagesArray=["chika1.png","chika2.png","chika3.png"];
const rightImagesArray=["chika4.png","chika5.png","chika6.png"];
const leftContainer=document.getElementById("leftImages");
const rightContainer=document.getElementById("rightImages");
const leftImg=new Image(), rightImg=new Image();
leftContainer.appendChild(leftImg); rightContainer.appendChild(rightImg);
function randomImage(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function updateImages(){ leftImg.src=randomImage(leftImagesArray); rightImg.src=randomImage(rightImagesArray); }
updateImages(); setInterval(updateImages,3000);
</script>
</body>
</html>
